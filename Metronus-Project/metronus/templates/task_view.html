{% extends "layout_base.html" %}
{% load i18n %}
{% load l10n %}
{% block title %}{% trans 'task' %}: {{ task.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="page-title">
        <div class="title_left">
            <h3><strong>{% trans 'task' %}: </strong> {{ task.name }}</h3>
        </div>

        <div class="clearfix"></div><br>


        <div class="">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="row x_title">
                        <div class="col-md-6">
                            <h2>{% trans 'datePicker' %}</h2>
                        </div>
                        <div class="col-md-6">
                            <div class="pull-right">
                                <!-- DataPicker para cambiar de fecha la gráfica -->
                                <fieldset>
                                    <div class="control-group">
                                        <div class="controls">
                                            <div class="input-prepend input-group">
                                                <span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                                                <input type="text" style="width: 200px" name="task_chart" id="task_chart" class="form-control" value="" />
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>

                    <div class="clearfix"></div>

                    <div class="x_content row">
                        <div class="col-xs-12">
                            <!-- Gráfica: muy importante el Style para que sea responsivo -->
                            <div id="task" style="width: 100%; min-height: 400px"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}



<script>
    /**
     * @fileoverview Funciones de la gráfica de Task
     * @author andjimrio
     * */

    /**
     * Con los datos que devuelve el Backend devuelve un JSON apto para editar la gráfica.
     * @param {Array} names nombre de las gráficas
     * @param {Array} data datos que se reciben de Backend
     * @return {Array} el JSON para la gráfica
     * */
    function fromData(names, data) {
        return {
            title: {
                text: '{% trans 'taskChartTitle' %}',
                subtext: '{% trans 'taskChartSubtitle' %}'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: names
            },
            toolbox: {
                show: true,
                feature: {
                    magicType: {
                        show: true,
                        title: {
                            line: '{% trans 'line' %}',
                            bar: '{% trans 'bar' %}',
                            stack: '{% trans  'stack' %}',
                            tiled: '{% trans 'tiled' %}'
                        },
                        type: ['line', 'bar', 'stack', 'tiled']
                    },
                    restore: {
                        show: false,
                        title: '{% trans 'restore' %}'
                    },
                    saveAsImage: {
                        show: true,
                        title: '{% trans 'saveImage' %}'
                    }
                }
            },
            calculable: true,
            xAxis: [{
                type: 'category',
                boundaryGap: false,
                data: data.days
            }],
            yAxis: [{
                type: 'value'
            }],
            series: [{
                name: names[0],
                type: 'line',
                smooth: true,
                itemStyle: {
                    normal: {
                        areaStyle: {
                            type: 'default'
                        }
                    }
                },

                data: data.production
            }, {
                name: names[1],
                type: 'line',
                smooth: true,
                itemStyle: {
                    normal: {
                        areaStyle: {
                            type: 'default'
                        }
                    }
                },
                data: data.goal_evolution
            }]
        };
    }


    $(document).ready(function() {
        //Nombres que se utilizarán en toda las gráficas
        names = ["{% trans 'production' %}", "{% trans 'goal_evolution' %}"];

        //Inicialización de la gráfica
        echartLine = echarts.init(document.getElementById('task'), theme);

        //Al principio, se piden los datos para una gráfica del mes actual
        $.get({
            url: "{% url 'productivity_per_task' %}",
            data: {task_id: {{ task.id }}},
            success: function ( backendData )  {
                data = backendData
                echartLine.setOption( fromData( names, backendData ) );
            }
        });

        //Esto se encarga de hacer responsivo (más o menos) el chart
        $(window).on('resize', function(){
            if(echartLine != null && echartLine != undefined){
                echartLine.resize();
            }
        });

        //Instanciación del DatePicker con el mes actual.
        defaultRange = moment().startOf('month').format('MM/DD/YYYY') +' - '+ moment().endOf('month').format('MM/DD/YYYY')
        $('input[name="task_chart"]').val(defaultRange)
        $('input[name="task_chart"]').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: '{% trans 'default' %}',
                applyLabel: '{% trans 'apply' %}'
            }
        });

        //Al pulsar el botón aplicar, pide por AJAX la nueva gráfica con dicho rango de fechas.
        $('input[name="task_chart"]').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
            $.get({
                url: "{% url 'productivity_per_task' %}",
                data: {
                    task_id: {{ task.id }},
                    start_date: picker.startDate.format('YYYY-MM-DD'),
                    end_date: picker.endDate.format('YYYY-MM-DD')
                },
                success: function ( backendData )  {
                    console.log(backendData)
                    echartLine.setOption( fromData( names, backendData ) );
                }
            });
        });

        //Al pulsar el botón cancelar, se ponen valores por defecto.
        $('input[name="task_chart"]').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val(defaultRange);
            echartLine.setOption( fromData( names, data ) );
        });
    });
</script>
{% endblock %}